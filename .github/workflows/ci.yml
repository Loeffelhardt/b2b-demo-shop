name: CI

on:
  pull_request:
  push:
    branches:
      - master
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  robot-mariadb-acceptance-alpine:
    name: "Robot / MariaDB / Acceptance / Alpine"
    runs-on: ubuntu-18.04
    env:
      PROGRESS_TYPE: plain
      SPRYKER_PLATFORM_IMAGE: spryker/php:7.4
      TRAVIS: 1

    steps:
      - uses: actions/checkout@v2

      - uses: actions/setup-python@v2
        with:
          python-version: '3.9'

      - name: Install apt-packages
        run: |
          sudo apt-get install apache2-utils

      - name: Install docker-compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/1.27.4/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose

      - name: Prepare robot
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install playwright==1.17.2
          python3 -m pip install robotframework==4.1.2
          python3 -m pip install robotframework-browser==11.1.1
          PLAYWRIGHT_BROWSERS_PATH=$HOME/pw-browsers rfbrowser init --skip-browsers
          PLAYWRIGHT_BROWSERS_PATH=$HOME/pw-browsers python3 -m playwright install-deps chromium
          PLAYWRIGHT_BROWSERS_PATH=$HOME/pw-browsers python3 -m playwright install chromium
          git clone https://github.com/spryker/robotframework-suite-tests.git --branch master --single-branch --depth 1 robotframework-tests

      - name: Run docker
        run: |
          git clone https://github.com/spryker/docker-sdk.git ./docker
          docker/sdk boot -v deploy.ci.acceptance.mariadb.yml
          docker/sdk up
          docker/sdk console scheduler:setup

      - name: Execute test
        run: |
          cd robotframework-tests/
          PLAYWRIGHT_BROWSERS_PATH=$HOME/pw-browsers robot -v env:b2b -v browser:chromium -v headless:true -v host:http://yves.de.spryker.local/ -v zed_url:http://backoffice.de.spryker.local/ -d results tests/smoke/smoke_b2b.robot
